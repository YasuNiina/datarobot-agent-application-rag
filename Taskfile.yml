---
# File generated by DataRobot CLI, regenerate using `dr task compose`
version: '3'
env:
  ENV: testing
dotenv: ['.env', '.env.{{.ENV}}']

includes:
  agent:
    taskfile: ./agent/Taskfile.yml
    dir: ./agent
  core:
    taskfile: ./core/Taskfile.yaml
    dir: ./core
  frontend_web:
    taskfile: ./frontend_web/Taskfile.yaml
    dir: ./frontend_web
  infra:
    taskfile: ./infra/Taskfile.yaml
    dir: ./infra
  mcp_server:
    taskfile: ./mcp_server/Taskfile.yaml
    dir: ./mcp_server
  fastapi_server:
    taskfile: ./fastapi_server/Taskfile.yaml
    dir: ./fastapi_server

tasks:
  default:
    desc: "â„¹ï¸ Show all available tasks (run `task --list-all` to see hidden tasks)"
    silent: true
    cmds:
      - task --list --sort none

  start:
    desc: "ğŸ’» Prepare local development environment"
    cmds:
      - dr self update
      - "echo 'âœ¨ Choose your agentic framework.'"
      - |
        PYTHONWARNINGS=ignore uvx copier recopy -a .datarobot/answers/agent-agent.yml \
        -r 11.4.23 \
        --data base_answers_file=.datarobot/answers/base.yml \
        --data agent_app_name=agent \
        --data fastmcp_answers_file=.datarobot/answers/fastmcp-mcp_server.yml \
        --data agent_development_port=8842 \
        --data include_taskfile_infra=no \
        --data llm_answers_file=.datarobot/answers/llm-llm.yml \
        -w --quiet
      - dr task compose
      - dr dotenv setup --if-needed
      - dr dotenv update
      - task install
      - dr task run start
      - echo 'âœ… You are all set. Run `task dev` to start developing, or run `task deploy` to deploy to DataRobot.'
  lint:
    desc: "ğŸ§¹ Run linters"
    cmds:
      - dr task run lint
  install:
    desc: "ğŸ› ï¸ Install all dependencies"
    cmds:
      - dr task run install
  test:
    desc: "ğŸ§ª Run tests across all components"
    cmds:
      - dr task run test

  auth-check:
    silent: true
    desc: "ğŸ” Check authentication prerequisites"
    cmds:
      - echo "ğŸ” Checking authentication.."
      - dr auth check

  dev:
    desc: "ğŸš€ Run all services together"
    deps:
      - auth-check
    cmds:
      - |
        task frontend_web:dev &
        sleep 3
        task mcp_server:dev &
        sleep 3
        task fastapi_server:dev &
        sleep 3
        task agent:dev &
        sleep 8
        echo "âœ… All servers started!"
        if [[ -n "$NOTEBOOK_ID" ]]; then
          prefix="${DATAROBOT_API_ENDPOINT//api\/v2/}notebook-sessions/$NOTEBOOK_ID/ports/"
        else
          prefix="http://localhost:"
        fi
        echo "ğŸ”— Backend: ${prefix}8080"
        echo "ğŸ”— Frontend: ${prefix}5173"
        echo "ğŸ”— Agent: ${prefix}8842"
        echo "ğŸ”— MCP Server: ${prefix}9000"
        wait

  deploy:
    desc: "ğŸš€ Deploy all services"
    env:
      AGENT_DEPLOY: "1"
    cmds:
      - task: infra:deploy

  deploy-dev:
    desc: "ğŸš€ Deploy infrastructure and services to development"
    cmds:
      - task: infra:deploy-dev
